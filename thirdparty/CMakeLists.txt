# SPDX-FileCopyrightText: 2023 The Naja authors <https://github.com/najaeda/naja/blob/main/AUTHORS>
#
# SPDX-License-Identifier: Apache-2.0

include(ExternalProject)

add_subdirectory(yosys-liberty)
add_subdirectory(naja-verilog)

set(SLANG_SOURCE_DIR ${CMAKE_CURRENT_SOURCE_DIR}/slang)
set(SLANG_BINARY_DIR ${CMAKE_BINARY_DIR}/thirdparty/slang-build)
set(SLANG_INSTALL_DIR ${CMAKE_BINARY_DIR}/thirdparty/slang-install)
set(SLANG_LIBRARY_NAME
  ${CMAKE_SHARED_LIBRARY_PREFIX}svlang${CMAKE_SHARED_LIBRARY_SUFFIX})
set(SLANG_LIBRARY_PATH ${SLANG_INSTALL_DIR}/${CMAKE_INSTALL_LIBDIR}/${SLANG_LIBRARY_NAME})

set(SLANG_CMAKE_ARGS
  -DCMAKE_INSTALL_PREFIX=${SLANG_INSTALL_DIR}
  -DCMAKE_INSTALL_LIBDIR=${CMAKE_INSTALL_LIBDIR}
  -DCMAKE_INSTALL_INCLUDEDIR=${CMAKE_INSTALL_INCLUDEDIR}
  -DCMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE}
  -DBUILD_SHARED_LIBS=ON
  -DSLANG_INCLUDE_TOOLS=OFF
  -DSLANG_INCLUDE_TESTS=OFF
  -DSLANG_INCLUDE_DOCS=OFF
  -DSLANG_INCLUDE_PYLIB=OFF
  -DSLANG_INCLUDE_PYTHON_DOCS=OFF
  -DSLANG_INCLUDE_INSTALL=ON
  -DSLANG_USE_MIMALLOC=OFF
  -DSLANG_USE_CPPTRACE=OFF
)

if(CMAKE_TOOLCHAIN_FILE)
  list(APPEND SLANG_CMAKE_ARGS -DCMAKE_TOOLCHAIN_FILE=${CMAKE_TOOLCHAIN_FILE})
endif()
if(CMAKE_C_COMPILER)
  list(APPEND SLANG_CMAKE_ARGS -DCMAKE_C_COMPILER=${CMAKE_C_COMPILER})
endif()
if(CMAKE_CXX_COMPILER)
  list(APPEND SLANG_CMAKE_ARGS -DCMAKE_CXX_COMPILER=${CMAKE_CXX_COMPILER})
endif()

ExternalProject_Add(slang_external
  SOURCE_DIR ${SLANG_SOURCE_DIR}
  BINARY_DIR ${SLANG_BINARY_DIR}
  INSTALL_DIR ${SLANG_INSTALL_DIR}
  CMAKE_ARGS ${SLANG_CMAKE_ARGS}
  BUILD_BYPRODUCTS ${SLANG_LIBRARY_PATH}
  EXCLUDE_FROM_ALL TRUE
)

# Create include/lib directories up front so imported target paths are valid
# during configure. The external install step populates them before use.
file(MAKE_DIRECTORY ${SLANG_INSTALL_DIR}/${CMAKE_INSTALL_INCLUDEDIR})
file(MAKE_DIRECTORY ${SLANG_INSTALL_DIR}/${CMAKE_INSTALL_LIBDIR})

add_library(slang::slang SHARED IMPORTED GLOBAL)
set_target_properties(slang::slang PROPERTIES
  IMPORTED_LOCATION ${SLANG_LIBRARY_PATH}
  INTERFACE_INCLUDE_DIRECTORIES ${SLANG_INSTALL_DIR}/${CMAKE_INSTALL_INCLUDEDIR}
)

add_subdirectory(googletest EXCLUDE_FROM_ALL)
if (NOT BUILD_EMSCRIPTEN AND NOT BUILD_NAJA_PYTHON)
  add_subdirectory(lefdef EXCLUDE_FROM_ALL)
endif()
#set(CPPTRACE_GET_SYMBOLS_WITH_LIBDWARF OFF CACHE BOOL "" FORCE)
#add_subdirectory(cpptrace EXCLUDE_FROM_ALL)
